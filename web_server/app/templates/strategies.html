{% extends "base.html" %}

{% block title %}전략 관리 - 트레이딩 자동화 시스템{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/strategies.css') }}">
{% endblock %}

{% block content %}
<div class="space-y-8 page-strategies">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <div class="header-icon">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>전략 관리</h1>
                    <p>트레이딩 전략을 효율적으로 생성, 수정하고 자본을 배분하세요.</p>
                </div>
            </div>
            <div class="header-actions">
                <button onclick="openAddStrategyModal()" 
                        class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    새 전략 추가
                </button>
            </div>
        </div>
    </div>

    <!-- 플래시 메시지 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                    <div class="flex justify-between items-center">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="alert-close">&times;</button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 탭 내비게이션 -->
    <div class="flex space-x-2 mb-4">
        <button id="tab-my" class="btn btn-secondary btn-sm" onclick="switchTab('my')">내 전략</button>
        <button id="tab-subscribed" class="btn btn-secondary btn-sm" onclick="switchTab('subscribed')">구독 전략</button>
        <button id="tab-discover" class="btn btn-secondary btn-sm" onclick="switchTab('discover')">공개 전략 탐색</button>
    </div>

    <!-- 전략 자본 재할당 -->
    <div class="mb-6">
        <button onclick="triggerCapitalReallocation(event)"
                class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg shadow-lg px-6 py-3 hover:shadow-xl hover:from-purple-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center space-x-2 font-semibold">
            <i class="fas fa-sync-alt"></i>
            <span>⚠️ 전략 자본 재할당 (강제)</span>
        </button>
    </div>

    <!-- 전략 목록 섹션: 내 전략 (서버 렌더 기본) -->
    <section id="section-my">
        <h2 class="text-2xl font-semibold strategy-title mb-6">내 전략</h2>
        
        {% if strategies %}
            <div class="space-y-8">
                {% for strategy in strategies %}
                <div class="strategy-card-new" id="strategy-card-{{ strategy.id }}">
                    <!-- 전략 카드 헤더 -->
                    <div class="strategy-card-header">
                        <div class="strategy-title-section">
                            <div class="strategy-title-row">
                                <h3>{{ strategy.name }}</h3>
                                <div class="strategy-badges">
                                    <!-- 활성 상태 배지 -->
                                    {% if strategy.is_active %}
                                        <span class="status-badge active" id="status-badge-{{ strategy.id }}">
                                            <div class="status-dot active"></div>
                                            활성
                                        </span>
                                    {% else %}
                                        <span class="status-badge inactive" id="status-badge-{{ strategy.id }}">
                                            <div class="status-dot inactive"></div>
                                            비활성
                                        </span>
                                    {% endif %}
                                    
                                    <!-- 마켓 타입 배지 -->
                                    {% if strategy.market_type == 'FUTURES' %}
                                        <span class="market-type-badge futures">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                            </svg>
                                            선물
                                        </span>
                                    {% else %}
                                        <span class="market-type-badge spot">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            현물
                                        </span>
                                    {% endif %}
                                    
                                    <!-- 공개 여부 배지 -->
                                    {% if strategy.is_public %}
                                        <span class="badge badge-accent">공개</span>
                                    {% else %}
                                        <span class="badge badge-secondary">비공개</span>
                                    {% endif %}
                                </div>
                            </div>
                            <p>{{ strategy.description or '단기 변동성 추종 전략 (예시 설명)' }}</p>
                        </div>
                        <div class="strategy-actions-section">
                            <!-- 토글 스위치 -->
                            <label class="toggle-switch-container" title="전략 활성화/비활성화">
                                <input type="checkbox" class="strategy-toggle sr-only" 
                                       data-strategy-id="{{ strategy.id }}" 
                                       {% if strategy.is_active %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                            </label>
                            
                            <!-- 액션 버튼들 -->
                            <button data-strategy-id="{{ strategy.id }}" onclick="editStrategy(this.dataset.strategyId)" 
                                    class="btn-action btn-action-secondary" title="전략 수정">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button data-strategy-id="{{ strategy.id }}" onclick="deleteStrategy(this.dataset.strategyId)" 
                                    class="btn-action btn-action-danger" title="전략 삭제">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 전략 정보 그리드 -->
                    <div class="strategy-grid-layout">
                        <!-- 전략 요약 -->
                        <div class="strategy-summary-card">
                            <div class="summary-header">
                                <h4>전략 요약</h4>
                            </div>
                            
                            <!-- 주요 지표 -->
                            <div class="summary-main-metrics">
                                <div class="main-metric">
                                    <!-- Phase 4.3: WARNING - Mixed exchange strategies not supported (first account only) -->
                                    {% set first_account = strategy.connected_accounts[0] if strategy.connected_accounts else None %}
                                    <p class="amount tabular-nums">{{ currency_symbol(Exchange, first_account.exchange if first_account else 'BINANCE') }}{{ "%.2f"|format(strategy.total_allocated_capital) }}</p>
                                    <p class="amount-label">총 할당 자본</p>
                                </div>
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon">
                                            <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                        </svg>
                                        <div>
                                            <span class="metric-value">{{ strategy.connected_accounts|length }}</span>
                                            <span class="metric-label">연결 계좌</span>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon">
                                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <div>
                                            <span class="metric-value">{{ strategy.position_count or 0 }}</span>
                                            <span class="metric-label">포지션</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 빠른 액션 -->
                            <div class="summary-quick-actions">
                                <a href="{{ url_for('main.strategy_positions', strategy_id=strategy.id) }}" 
                                   class="quick-action-btn quick-action-view">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    포지션 보기
                                </a>
                                
                                <button onclick="openAccountModal('{{ strategy.id }}')" 
                                        class="quick-action-btn quick-action-add" 
                                        title="계좌 연동">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                    </svg>
                                    계좌 연동
                                </button>
                                
                                {% if strategy.connected_accounts %}
                                <button onclick="openCapitalModal('{{ strategy.id }}')" 
                                        class="quick-action-btn quick-action-manage" 
                                        title="자본 관리">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd"/>
                                    </svg>
                                    자본 관리
                                </button>
                                {% else %}
                                <div class="empty-state-hint">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="hint-icon">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>계좌를 연결하여 자동매매를 시작하세요</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 연결된 계좌 및 자본 배분 -->
                        <div class="strategy-accounts-section">
                            <h4>연결된 계좌 및 자본 배분</h4>
                            <div class="strategy-accounts-list" id="strategy-accounts-{{ strategy.id }}">
                                {% if strategy.connected_accounts %}
                                    {% for account in strategy.connected_accounts %}
                                    <div class="strategy-account-item">
                                        <div class="strategy-account-info">
                                            <p>{{ account.exchange.title() }} - {{ account.name }}</p>
                                            <p>가중치: {{ account.weight }} | {% if account.max_symbols %}최대: {{ account.max_symbols }}개{% else %}최대: -{% endif %} | 레버리지: {{ account.leverage }}x</p>
                                        </div>
                                        <div class="strategy-account-amount">
                                            <p class="amount tabular-nums">{{ currency_symbol(Exchange, account.exchange) }}{{ "%.2f"|format(account.allocated_capital) }}</p>
                                            <p class="currency">USDT{% if account.exchange == 'upbit' %} 환산{% endif %}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8 text-muted">
                                        <p>연결된 계좌가 없습니다</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="mx-auto w-24 h-24 bg-gradient-to-r from-purple-100 to-blue-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-primary mb-2">등록된 전략이 없습니다</h3>
                <p class="text-muted mb-6">첫 번째 트레이딩 전략을 추가하여 시작하세요.</p>
                <button onclick="openAddStrategyModal()" 
                        class="btn btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    첫 번째 전략 추가
                </button>
            </div>
        {% endif %}
    </section>

    <!-- 전략 목록 섹션: 구독 전략 (클라이언트 렌더) -->
    <section id="section-subscribed" class="hidden">
        <h2 class="text-2xl font-semibold strategy-title mb-6">구독 전략</h2>
        <div id="subscribed-strategies" class="space-y-8"></div>
    </section>

    <!-- 전략 목록 섹션: 공개 전략 탐색 (클라이언트 렌더) -->
    <section id="section-discover" class="hidden">
        <h2 class="text-2xl font-semibold strategy-title mb-6">공개 전략 탐색</h2>
        <div id="public-strategies" class="space-y-4"></div>
    </section>
</div>

<!-- 토스트 컨테이너 -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- 전략 추가/수정 모달 -->
<div id="strategyModal" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-accent rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 id="strategyModalTitle" class="text-lg font-semibold text-primary">전략 추가</h3>
            </div>
            <button onclick="closeStrategyModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="strategyForm" onsubmit="submitStrategy(event)">
                <input type="hidden" id="strategyId" name="strategy_id">
                
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="name" class="form-label">전략명</label>
                        <input type="text" id="name" name="name" required class="form-input" placeholder="예: RSI 역추세 전략">
                    </div>
                    
                    <div class="form-group">
                        <label for="description" class="form-label">설명</label>
                        <textarea id="description" name="description" rows="3" class="form-textarea" placeholder="전략에 대한 설명을 입력하세요"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="group_name" class="form-label">그룹명</label>
                        <input type="text" id="group_name" name="group_name" class="form-input" placeholder="예: 역추세 전략군">
                    </div>
                    
                    <div class="form-group">
                        <label for="market_type" class="form-label">마켓 타입</label>
                        <select id="market_type" name="market_type" required class="form-select">
                            <option value="">선택하세요</option>
                            <option value="spot">현물</option>
                            <option value="futures">선물</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="is_active" name="is_active" 
                               class="rounded border-color text-accent shadow-sm focus:border-accent focus:ring focus:ring-accent focus:ring-opacity-50">
                        <label for="is_active" class="ml-2 text-sm text-primary">전략 활성화</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="is_public" name="is_public" 
                               class="rounded border-color text-accent shadow-sm focus:border-accent focus:ring focus:ring-accent focus:ring-opacity-50">
                        <label for="is_public" class="ml-2 text-sm text-primary">공개 전략</label>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeStrategyModal()" 
                            class="btn btn-secondary flex-1">
                        취소
                    </button>
                    <button type="submit" 
                            class="btn btn-primary flex-1">
                        저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 계좌 연결 모달 -->
<div id="accountModal" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-accent rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-primary">공개 전략 구독</h3>
            </div>
            <button onclick="closeAccountModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="accountModalContent">
                <!-- 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>
</div>

<!-- 자본 배분 모달 -->
<div id="capitalModal" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-success rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-primary">자본 배분 관리</h3>
            </div>
            <button onclick="closeCapitalModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="capitalModalContent">
                <!-- 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>
</div>

<script>
// Toast 알림 기능은 전역 toast.js를 사용합니다 (base.html에서 로드됨)
// showToast(message, type, duration) 함수는 전역으로 사용 가능합니다

// Phase 4.3: Exchange type helper functions
// Sync with: web_server/app/constants.py:Exchange.DOMESTIC_EXCHANGES (Line 249)
function isExchangeDomestic(exchange) {
    const domesticExchanges = ['UPBIT', 'BITHUMB'];
    return domesticExchanges.includes(exchange?.toUpperCase());
}

function getCurrencySymbol(exchange) {
    return isExchangeDomestic(exchange) ? '₩' : '$';
}

// CSRF 토큰
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// @FEAT:futures-validation @COMP:route @TYPE:integration
// 거래소 메타데이터 로드 (페이지 로드 시 1회)
(async function loadExchangeMetadata() {
    try {
        const response = await fetch('/api/system/exchange-metadata');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        window.EXCHANGE_METADATA = data.payload || data; // 하위 호환
        console.log('✅ Exchange metadata loaded');
    } catch (error) {
        console.warn('⚠️ Failed to load exchange metadata, validation will be skipped:', error);
        window.EXCHANGE_METADATA = null;
    }
})();

// API 응답 처리 유틸리티 함수들
function handleApiResponse(response) {
    if (!response.ok) {
        throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
    }
    return response.json();
}

function handleApiError(error, operation) {
    console.error(`${operation} 실패:`, error);
    const message = error.message || `${operation} 중 오류가 발생했습니다.`;
    showToast(message, 'error');
    return null;
}

function getPayload(responseJson) {
    if (!responseJson || typeof responseJson !== 'object') {
        return {};
    }
    return responseJson.data || {};
}

function getErrorMessage(responseJson, fallback = '알 수 없는 오류가 발생했습니다.') {
    if (!responseJson || typeof responseJson !== 'object') {
        return fallback;
    }

    const error = responseJson.error;
    if (typeof error === 'string') {
        return error;
    }
    if (error && typeof error === 'object' && error.message) {
        return error.message;
    }

    return responseJson.message || fallback;
}

function showLoadingState(element, message = '로딩 중...') {
    element.innerHTML = `
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">${message}</div>
        </div>
    `;
}

function showErrorState(element, message, retryFunction = null) {
    const retryButton = retryFunction ? `
        <button onclick="${retryFunction}" class="btn btn-primary btn-sm">
            다시 시도
        </button>
    ` : '';
    
    element.innerHTML = `
        <div class="text-center py-8">
            <div class="text-error mb-4">
                <svg class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <p class="text-lg font-medium">오류 발생</p>
            </div>
            <p class="text-muted mb-4">${message}</p>
            ${retryButton}
        </div>
    `;
}



function switchTab(tab) {
    const sections = {
        my: document.getElementById('section-my'),
        subscribed: document.getElementById('section-subscribed'),
        discover: document.getElementById('section-discover')
    };
    Object.values(sections).forEach(s => s.classList.add('hidden'));
    sections[tab]?.classList.remove('hidden');

    // Load data when switching to subscribed or discover
    if (tab === 'subscribed') {
        loadSubscribedStrategies();
    } else if (tab === 'discover') {
        loadPublicStrategies();
    }
}

function loadSubscribedStrategies() {
    fetch('/api/strategies/accessibles', { headers: { 'X-CSRFToken': getCSRFToken() }})
        .then(handleApiResponse)
        .then(data => {
            const container = document.getElementById('subscribed-strategies');
            if (!data.success) {
                container.innerHTML = `<div class="text-error">${getErrorMessage(data, '구독 전략을 불러오지 못했습니다.')}</div>`;
                return;
            }
            const payload = getPayload(data);
            const items = (payload.strategies || []).filter(s => s.ownership === 'subscriber');
            if (items.length === 0) {
                container.innerHTML = '<div class="text-muted">구독 중인 전략이 없습니다.</div>';
                return;
            }
            container.innerHTML = items.map(renderSubscribedStrategy).join('');
        })
        .catch(() => {
            document.getElementById('subscribed-strategies').innerHTML = '<div class="text-error">오류가 발생했습니다.</div>';
        });
}

function renderSubscribedStrategy(s) {
    const accounts = s.connected_accounts || [];
    const publicBadge = s.is_public ? '<span class="badge badge-accent ml-2">공개</span>' : '<span class="badge badge-secondary ml-2">비공개</span>';
    const activeBadge = s.is_active ? '<span class="status-badge active"><div class="status-dot active"></div>활성</span>' : '<span class="status-badge inactive"><div class="status-dot inactive"></div>비활성</span>';

    // 총 자본 합계 (있다면)
    const totalAllocated = accounts.reduce((sum, a) => sum + (a.allocated_capital || 0), 0);
    const positionCount = s.position_count || 0;
    const firstAccount = accounts[0];
    const currencySymbol = getCurrencySymbol(firstAccount?.exchange || 'BINANCE');

    return `
    <div class="strategy-card-new" id="strategy-card-${s.id}">
      <div class="strategy-card-header">
        <div class="strategy-title-section">
          <div class="strategy-title-row">
            <h3>${s.name}</h3>
            <div class="strategy-badges">
              ${activeBadge}
              ${s.market_type === 'futures' ? `
                <span class="market-type-badge futures">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/></svg>
                  선물
                </span>` : `
                <span class="market-type-badge spot">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                  현물
                </span>`}
              ${publicBadge}
            </div>
          </div>
          <p>${s.description || ''}</p>
        </div>
        <div class="strategy-actions-section">
          <button onclick="openSubscribeModal(${s.id})" class="btn-action btn-action-secondary" title="구독 관리">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
          </button>
        </div>
      </div>

      <div class="strategy-grid-layout">
        <div class="strategy-summary-card">
          <div class="summary-header"><h4>전략 요약</h4></div>
          <div class="summary-main-metrics">
            <div class="main-metric">
              <p class="amount tabular-nums">${currencySymbol}${totalAllocated.toFixed(2)}</p>
              <p class="amount-label">총 할당 자본</p>
            </div>
            <div class="metric-grid">
              <div class="metric-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon"><path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/></svg>
                <div>
                  <span class="metric-value">${accounts.length}</span>
                  <span class="metric-label">내 연결 계좌</span>
                </div>
              </div>
              <div class="metric-item">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                <div>
                  <span class="metric-value">${positionCount}</span>
                  <span class="metric-label">포지션</span>
                </div>
              </div>
            </div>
          </div>
          <div class="summary-quick-actions">
            <a href="/strategies/${s.id}/positions" class="quick-action-btn quick-action-view" title="포지션 보기">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
              </svg>
              포지션 보기
            </a>
            <button onclick="openSubscribeModal(${s.id})" class="quick-action-btn quick-action-add" title="계좌 연동">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
              계좌 연동
            </button>
          </div>
        </div>

        <div class="strategy-accounts-section">
          <h4>내 연결 계좌</h4>
          <div class="strategy-accounts-list" id="strategy-accounts-${s.id}">
            ${accounts.length ? accounts.map(a => `
              <div class="strategy-account-item">
                <div class="strategy-account-info">
                  <p>${a.exchange.toUpperCase()} - ${a.name} ${a.is_active === false ? '<span class=\"badge badge-secondary ml-2\">비활성</span>' : ''}</p>
                  <p>가중치: ${a.weight} | ${a.max_symbols ? `최대: ${a.max_symbols}개` : '최대: -'} | 레버리지: ${a.leverage}x</p>
                </div>
                <div class="strategy-account-amount">
                  <p class="amount tabular-nums">${getCurrencySymbol(a.exchange)}${(a.allocated_capital || 0).toFixed(2)}</p>
                  <p class="currency">USDT</p>
                </div>
                <div class="flex items-center space-x-2">
                  <button class="btn btn-secondary btn-xs" onclick="openSubscribeSettings(${s.id}, ${a.account_id}, '${a.exchange.toUpperCase()} - ${a.name}')">설정</button>
                  <button class="btn btn-error btn-xs" onclick="unsubscribeStrategy(${s.id}, ${a.account_id})">구독 해제</button>
                </div>
              </div>
            `).join('') : '<div class="text-center py-8 text-muted">연결된 계좌가 없습니다</div>'}
          </div>
        </div>
      </div>
    </div>`;
}

function loadPublicStrategies() {
    fetch('/api/strategies/public', { headers: { 'X-CSRFToken': getCSRFToken() }})
        .then(handleApiResponse)
        .then(data => {
            const container = document.getElementById('public-strategies');
            if (!data.success) {
                container.innerHTML = `<div class="text-error">${getErrorMessage(data, '공개 전략을 불러오지 못했습니다.')}</div>`;
                return;
            }
            const payload = getPayload(data);
            const items = payload.strategies || [];
            if (items.length === 0) {
                container.innerHTML = '<div class="text-muted">공개된 전략이 없습니다.</div>';
                return;
            }
            container.innerHTML = items.map(renderPublicStrategy).join('');
        })
        .catch(() => {
            document.getElementById('public-strategies').innerHTML = '<div class="text-error">오류가 발생했습니다.</div>';
        });
}

function renderPublicStrategy(s) {
    return `
    <div class="card-inner">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-lg font-semibold text-primary">${s.name}</div>
                <div class="text-sm text-muted">${s.description || ''}</div>
            </div>
            <div class="flex items-center space-x-2">
                <button class="btn btn-secondary btn-sm" onclick="openPublicDetail(${s.id})">자세히</button>
                <button class="btn btn-primary btn-sm" onclick="openSubscribeModal(${s.id})">구독하기</button>
            </div>
        </div>
    </div>`;
}

function openSubscribeModal(strategyId) {
    // 기존 계좌 연결 모달을 재사용
    document.getElementById('accountModal').classList.remove('hidden');
    renderSubscribeAccountPicker(strategyId);
}

function renderSubscribeAccountPicker(strategyId) {
    const modalContent = document.getElementById('accountModalContent');
    modalContent.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">로딩 중...</div></div>';
    
    // 내 계좌 목록만 불러옴
    fetch('/api/accounts', { headers: { 'X-CSRFToken': getCSRFToken() }})
      .then(handleApiResponse)
      .then(data => {
        console.log('계좌 목록 로드 결과:', data);

        if (!data.success) {
          throw new Error(getErrorMessage(data, '계좌 목록을 불러올 수 없습니다.'));
        }

        const payload = getPayload(data);
        const accounts = payload.accounts || [];
        let html = `
        <div class="space-y-6">
          <div class="bg-info bg-opacity-10 border border-info rounded-lg p-4">
            <div class="flex items-start">
                <svg class="h-5 w-5 text-info mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 100-16 8 8 0 000 16zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                <div>
                    <h4 class="text-sm font-medium text-info">구독 설정 안내</h4>
                    <p class="text-sm text-info mt-1">각 계좌마다 가중치/레버리지/최대 보유 심볼 수를 개별 설정할 수 있습니다.</p>
                </div>
            </div>
          </div>`;
        if (accounts.length === 0) {
           html += '<div class="text-center py-8 text-muted">등록된 계좌가 없습니다.</div>';
        } else {
          accounts.forEach(acc => {
            html += `
            <div class="card-inner">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-accent bg-opacity-20 rounded-full flex items-center justify-center">
                        <span class="text-sm font-bold text-accent">${acc.exchange.toUpperCase().charAt(0)}</span>
                    </div>
                    <div>
                        <div class="font-medium text-primary">${acc.exchange.toUpperCase()} - ${acc.name}</div>
                        <div class="text-xs text-muted">내 계좌</div>
                    </div>
                </div>
                <button class="btn btn-primary btn-sm" onclick="openSubscribeSettings(${strategyId}, ${acc.id}, '${acc.exchange.toUpperCase()} - ${acc.name}')">구독 설정</button>
              </div>
            </div>`;
          });
        }
        html += '</div>';
        modalContent.innerHTML = html;
      })
      .catch(error => {
        console.error('계좌 목록 로드 실패:', error);
        const errorMessage = error.message || '계좌 목록을 불러오는 중 오류가 발생했습니다.';
        modalContent.innerHTML = `
          <div class="text-center py-8">
            <div class="text-error mb-4">
              <svg class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <p class="text-lg font-medium">계좌 로드 실패</p>
            </div>
            <p class="text-muted mb-4">${errorMessage}</p>
            <button onclick="renderSubscribeAccountPicker(${strategyId})" class="btn btn-primary btn-sm">
              다시 시도
            </button>
          </div>
        `;
        showToast('계좌 로드 실패: ' + errorMessage, 'error');
      });
}

function openSubscribeSettings(strategyId, accountId, accountLabel) {
    const modalContent = document.getElementById('accountModalContent');
    modalContent.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <h4 class="text-lg font-medium text-primary">구독 설정</h4>
                <button onclick="renderSubscribeAccountPicker(${strategyId})" class="btn btn-secondary btn-sm">
                    돌아가기
                </button>
            </div>
            <div class="text-sm text-muted">대상 계좌: ${accountLabel}</div>
            <form id="subscribeSettingsForm" onsubmit="submitSubscribeSettings(event, ${strategyId}, ${accountId})">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">가중치</label>
                        <input type="number" step="0.1" min="0.1" max="10" value="1.0" name="weight" required class="form-input" placeholder="1.0">
                        <p class="text-sm text-muted mt-1">전체 자본 대비 이 계좌에 할당할 비율 (1.0 = 100%)</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">레버리지</label>
                        <input type="number" step="0.1" min="1" max="100" value="1.0" name="leverage" required class="form-input" placeholder="1.0">
                        <p class="text-sm text-muted mt-1">사용할 레버리지 배수</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">최대 보유 심볼 수 (선택사항)</label>
                        <input type="number" min="1" max="100" name="max_symbols" class="form-input" placeholder="예: 10">
                        <p class="text-sm text-muted mt-1">이 계좌에서 동시에 보유할 수 있는 최대 심볼 수</p>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="renderSubscribeAccountPicker(${strategyId})" class="btn btn-secondary flex-1">취소</button>
                    <button type="submit" class="btn btn-primary flex-1">구독</button>
                </div>
            </form>
        </div>
    `;
}

function submitSubscribeSettings(event, strategyId, accountId) {
    event.preventDefault();
    const form = document.getElementById('subscribeSettingsForm');
    const fd = new FormData(form);
    const weight = parseFloat(fd.get('weight'));
    const leverage = parseFloat(fd.get('leverage'));
    const maxSymbolsRaw = (fd.get('max_symbols') || '').toString().trim();

    if (!(weight > 0 && weight <= 10)) {
        showToast('가중치는 0.1~10.0 사이여야 합니다.', 'error');
        return;
    }
    if (!(leverage >= 1 && leverage <= 100)) {
        showToast('레버리지는 1~100 사이여야 합니다.', 'error');
        return;
    }
    const body = { account_id: accountId, weight, leverage };
    if (maxSymbolsRaw) {
        const ms = parseInt(maxSymbolsRaw);
        if (!(ms >= 1 && ms <= 100)) {
            showToast('최대 심볼 수는 1~100 사이의 정수여야 합니다.', 'error');
            return;
        }
        body.max_symbols = ms;
    }
    fetch(`/api/strategies/${strategyId}/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(body)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            const payload = getPayload(data);
            showToast('구독이 완료되었습니다.', 'success');
            closeAccountModal();
            loadSubscribedStrategies();
        } else {
            showToast('구독 실패: ' + getErrorMessage(data), 'error');
        }
    })
    .catch(err => showToast('구독 중 오류: ' + err.message, 'error'));
}

function subscribeStrategy(strategyId, accountId) {
    // 입력값 수집 및 간단 검증
    const weightEl = document.getElementById(`weight-${accountId}`);
    const leverageEl = document.getElementById(`leverage-${accountId}`);
    const maxSymbolsEl = document.getElementById(`maxsymbols-${accountId}`);

    const weight = parseFloat(weightEl?.value || '1.0');
    const leverage = parseFloat(leverageEl?.value || '1.0');
    const maxSymbolsRaw = maxSymbolsEl?.value?.trim();

    if (!(weight > 0 && weight <= 10)) {
        showToast('가중치는 0.1~10.0 사이여야 합니다.', 'error');
        return;
    }
    if (!(leverage >= 1 && leverage <= 100)) {
        showToast('레버리지는 1~100 사이여야 합니다.', 'error');
        return;
    }

    const body = { account_id: accountId, weight, leverage };
    if (maxSymbolsRaw) {
        const ms = parseInt(maxSymbolsRaw);
        if (!(ms >= 1 && ms <= 100)) {
            showToast('최대 심볼 수는 1~100 사이의 정수여야 합니다.', 'error');
            return;
        }
        body.max_symbols = ms;
    }
    fetch(`/api/strategies/${strategyId}/subscribe`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(body)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            const payload = getPayload(data);
            showToast('구독이 완료되었습니다.', 'success');
            closeAccountModal();
            // 갱신
            loadSubscribedStrategies();
        } else {
            showToast('구독 실패: ' + getErrorMessage(data), 'error');
        }
    })
    .catch(err => showToast('구독 중 오류: ' + err.message, 'error'));
}

function unsubscribeStrategy(strategyId, accountId) {
    if (!confirm('이 전략에서 해당 계좌의 구독을 해제하시겠습니까? 활성 포지션이 있으면 해제할 수 없습니다.')) return;
    fetch(`/api/strategies/${strategyId}/subscribe/${accountId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            showToast('구독이 해제되었습니다.', 'success');
            loadSubscribedStrategies();
        } else {
            showToast('구독 해제 실패: ' + getErrorMessage(data), 'error');
        }
    })
    .catch(err => showToast('구독 해제 중 오류: ' + err.message, 'error'));
}

function openPublicDetail(strategyId) {
    const modal = document.getElementById('accountModal');
    modal.classList.remove('hidden');
    const modalContent = document.getElementById('accountModalContent');
    modalContent.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">로딩 중...</div></div>';
    fetch(`/api/strategies/public/${strategyId}`, { headers: { 'X-CSRFToken': getCSRFToken() }})
      .then(handleApiResponse)
      .then(data => {
        if (!data.success) {
            modalContent.innerHTML = `<div class="text-center py-8 text-error">${getErrorMessage(data, '전략 정보를 불러오지 못했습니다.')}</div>`;
            return;
        }
        const payload = getPayload(data);
        const s = payload.strategy;
        if (!s) {
            modalContent.innerHTML = '<div class="text-center py-8 text-error">전략 정보를 찾을 수 없습니다.</div>';
            return;
        }
        modalContent.innerHTML = `
            <div class="space-y-4">
                <div>
                    <div class="text-lg font-semibold text-primary">${s.name}</div>
                    <div class="text-sm text-muted">${s.description || ''}</div>
                    <div class="text-xs text-secondary mt-1">마켓: ${s.market_type.toUpperCase()}</div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button class="btn btn-secondary" onclick="renderSubscribeAccountPicker(${s.id})">계좌 선택하여 구독</button>
                </div>
            </div>
        `;
      })
      .catch(() => {
        modalContent.innerHTML = '<div class="text-center py-8 text-error">오류가 발생했습니다.</div>';
      });
}
// 전략 관련 함수들
function openAddStrategyModal() {
    document.getElementById('strategyModalTitle').textContent = '전략 추가';
    document.getElementById('strategyForm').reset();
    document.getElementById('strategyId').value = '';
    document.getElementById('strategyModal').classList.remove('hidden');
}

function closeStrategyModal() {
    document.getElementById('strategyModal').classList.add('hidden');
}

function editStrategy(strategyId) {
    // 전략 정보 로드
    fetch(`/api/strategies/${strategyId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            const payload = getPayload(data);
            const strategy = payload.strategy;
            if (!strategy) {
                throw new Error('전략 데이터를 찾을 수 없습니다.');
            }
            
            document.getElementById('strategyModalTitle').textContent = '전략 수정';
            document.getElementById('strategyId').value = strategy.id;
            document.getElementById('name').value = strategy.name || '';
            document.getElementById('description').value = strategy.description || '';
            document.getElementById('group_name').value = strategy.group_name || '';
            document.getElementById('market_type').value = strategy.market_type ? strategy.market_type.toLowerCase() : '';
            document.getElementById('is_active').checked = strategy.is_active || false;
            document.getElementById('is_public').checked = strategy.is_public || false;
            
            document.getElementById('strategyModal').classList.remove('hidden');
        } else {
            throw new Error(getErrorMessage(data, '전략 정보를 불러오지 못했습니다.'));
        }
    })
    .catch(error => {
        showToast('전략 정보를 불러오는 중 오류가 발생했습니다: ' + error.message, 'error');
    });
}

function deleteStrategy(strategyId) {
    if (confirm('정말로 이 전략을 삭제하시겠습니까? 연결된 계좌와 포지션이 있는 경우 삭제할 수 없습니다.')) {
        fetch(`/api/strategies/${strategyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(handleApiResponse)
        .then(data => {
            if (data.success) {
                showToast('전략이 성공적으로 삭제되었습니다.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('전략 삭제 실패: ' + getErrorMessage(data), 'error');
            }
        })
        .catch(error => {
            showToast('전략 삭제 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}

function submitStrategy(event) {
    event.preventDefault();
    
    const form = document.getElementById('strategyForm');
    const formData = new FormData(form);
    const strategyId = document.getElementById('strategyId').value;
    
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        group_name: formData.get('group_name'),
        market_type: formData.get('market_type'),
        is_active: formData.get('is_active') === 'on',
        is_public: formData.get('is_public') === 'on'
    };
    
    const url = strategyId ? `/api/strategies/${strategyId}` : '/api/strategies';
    const method = strategyId ? 'PUT' : 'POST';
    
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<div class="loading-spinner"></div>저장 중...';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            showToast(strategyId ? '전략이 성공적으로 수정되었습니다.' : '전략이 성공적으로 생성되었습니다.', 'success');
            closeStrategyModal();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('저장 실패: ' + getErrorMessage(data), 'error');
        }
    })
    .catch(error => {
        showToast('저장 중 오류가 발생했습니다: ' + error.message, 'error');
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

function openAccountModal(strategyId) {
    document.getElementById('accountModal').classList.remove('hidden');
    loadStrategyAccountModal(strategyId);
}

function closeAccountModal() {
    document.getElementById('accountModal').classList.add('hidden');
}

function loadStrategyAccountModal(strategyId) {
    const modalContent = document.getElementById('accountModalContent');
    modalContent.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">로딩 중...</div></div>';
    
    // 사용자의 모든 계좌와 전략의 연결된 계좌 정보 조회
    Promise.all([
        fetch('/api/accounts', {
            headers: { 'X-CSRFToken': getCSRFToken() }
        }).then(handleApiResponse),
        fetch(`/api/strategies/${strategyId}/accounts`, {
            headers: { 'X-CSRFToken': getCSRFToken() }
        }).then(handleApiResponse)
    ])
    .then(([accountsResult, strategyAccountsResult]) => {
        console.log('계좌 정보 로드 결과:', { accountsResult, strategyAccountsResult });
        
        if (!accountsResult.success) {
            throw new Error(`계좌 정보 조회 오류: ${getErrorMessage(accountsResult)}`);
        }
        if (!strategyAccountsResult.success) {
            throw new Error(`전략 계좌 정보 조회 오류: ${getErrorMessage(strategyAccountsResult)}`);
        }
        
        const allAccounts = getPayload(accountsResult).accounts || [];
        const linkedAccounts = getPayload(strategyAccountsResult).accounts || [];
        renderAccountModal(strategyId, allAccounts, linkedAccounts);
    })
    .catch(error => {
        console.error('계좌 정보 로드 실패:', error);
        const errorMessage = error.message || '계좌 정보를 불러오는 중 오류가 발생했습니다.';
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="text-error mb-4">
                    <svg class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-lg font-medium">데이터 로드 실패</p>
                </div>
                <p class="text-muted mb-4">${errorMessage}</p>
                <button onclick="loadStrategyAccountModal(${strategyId})" class="btn btn-primary btn-sm">
                    다시 시도
                </button>
            </div>
        `;
        showToast('계좌 정보 로드 실패: ' + errorMessage, 'error');
    });
}

function renderAccountModal(strategyId, allAccounts, connectedAccounts) {
    const modalContent = document.getElementById('accountModalContent');
    
    const connectedAccountIds = new Set(connectedAccounts.map(acc => acc.id));
    
    let html = `
        <div class="space-y-6">
            <div>
                <h4 class="text-lg font-medium text-primary mb-4">사용 가능한 계좌</h4>
                <div class="space-y-3">
    `;
    
    if (allAccounts.length === 0) {
        html += '<div class="text-center py-8 text-muted">등록된 계좌가 없습니다.</div>';
    } else {
        allAccounts.forEach(account => {
            const isConnected = connectedAccountIds.has(account.id);
            const connectedAccount = connectedAccounts.find(ca => ca.id === account.id);
            
            html += `
                <div class="account-item ${isConnected ? 'border-accent' : ''}">
                    <div class="flex items-center space-x-3 flex-1">
                        <div class="w-8 h-8 bg-accent bg-opacity-20 rounded-full flex items-center justify-center">
                            <span class="text-sm font-bold text-accent">${account.exchange.toUpperCase().charAt(0)}</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-primary">${account.exchange.charAt(0).toUpperCase() + account.exchange.slice(1)} - ${account.name}</div>
                            <div class="text-sm text-muted">${account.is_active ? '활성' : '비활성'}</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${isConnected ? `
                            <span class="badge badge-success">연결됨</span>
                            <button onclick="disconnectAccount(${strategyId}, ${account.id})" class="btn btn-error btn-sm">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                연결 해제
                            </button>
                            <button onclick="editConnection(${strategyId}, ${account.id})" 
                                    data-weight="${connectedAccount ? connectedAccount.weight : 1.0}"
                                    data-leverage="${connectedAccount ? connectedAccount.leverage : 1.0}"
                                    data-max-symbols="${connectedAccount ? connectedAccount.max_symbols || '' : ''}"
                                    class="btn btn-secondary btn-sm">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                                설정
                            </button>
                        ` : `
                            <button onclick="connectAccount(${strategyId}, ${account.id})" class="btn btn-primary btn-sm">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                연결
                            </button>
                        `}
                    </div>
                </div>
            `;
        });
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    modalContent.innerHTML = html;
}

function connectAccount(strategyId, accountId) {
    // 연결 설정 폼 표시
    showConnectionForm(strategyId, accountId, 'connect');
}

function editConnection(strategyId, accountId) {
    // 기존 연결 설정 편집 폼 표시
    const button = event.target.closest('button');
    const existingData = {
        weight: parseFloat(button.dataset.weight),
        leverage: parseFloat(button.dataset.leverage),
        max_symbols: button.dataset.maxSymbols || null
    };
    showConnectionForm(strategyId, accountId, 'edit', existingData);
}

function showConnectionForm(strategyId, accountId, mode, existingData = null) {
    const modalContent = document.getElementById('accountModalContent');
    
    const weight = existingData?.weight || 1.0;
    const leverage = existingData?.leverage || 1.0;
    const maxSymbols = existingData?.max_symbols || '';
    
    modalContent.innerHTML = `
        <div class="space-y-6">
            <div class="flex items-center space-x-3">
                <button onclick="loadStrategyAccountModal(${strategyId})" class="btn btn-secondary btn-sm">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    돌아가기
                </button>
                <h4 class="text-lg font-medium text-primary">${mode === 'edit' ? '연결 설정 수정' : '계좌 연결'}</h4>
            </div>
            
            <form id="connectionForm" onsubmit="submitConnection(event, ${strategyId}, ${accountId}, '${mode}')">
                <div class="space-y-4">
                    <div class="form-group">
                        <label class="form-label">가중치</label>
                        <input type="number" step="0.1" min="0.1" max="10" value="${weight}" name="weight" required class="form-input" placeholder="1.0">
                        <p class="text-sm text-muted mt-1">전체 자본 대비 이 계좌에 할당할 비율 (1.0 = 100%)</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">레버리지</label>
                        <input type="number" step="0.1" min="1" max="100" value="${leverage}" name="leverage" required class="form-input" placeholder="1.0">
                        <p class="text-sm text-muted mt-1">사용할 레버리지 배수</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">최대 보유 심볼 수 (선택사항)</label>
                        <input type="number" min="1" max="100" value="${maxSymbols}" name="max_symbols" class="form-input" placeholder="예: 10">
                        <p class="text-sm text-muted mt-1">이 계좌에서 동시에 보유할 수 있는 최대 심볼 수</p>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="loadStrategyAccountModal(${strategyId})" class="btn btn-secondary flex-1">
                        취소
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        ${mode === 'edit' ? '수정' : '연결'}
                    </button>
                </div>
            </form>
        </div>
    `;
}

function submitConnection(event, strategyId, accountId, mode) {
    event.preventDefault();
    
    const form = document.getElementById('connectionForm');
    const formData = new FormData(form);
    
    const data = {
        account_id: accountId,
        weight: parseFloat(formData.get('weight')),
        leverage: parseFloat(formData.get('leverage'))
    };
    
    const maxSymbols = formData.get('max_symbols');
    if (maxSymbols && maxSymbols.trim() !== '') {
        data.max_symbols = parseInt(maxSymbols);
    }
    
    const url = mode === 'edit' 
        ? `/api/strategies/${strategyId}/accounts/${accountId}`
        : `/api/strategies/${strategyId}/accounts`;
    const method = mode === 'edit' ? 'PUT' : 'POST';
    
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.disabled = true;
    submitButton.innerHTML = '<div class="loading-spinner"></div>처리 중...';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            showToast(mode === 'edit' ? '연결 설정이 성공적으로 수정되었습니다.' : '계좌가 성공적으로 연결되었습니다.', 'success');
            loadStrategyAccountModal(strategyId);
            
            // 전략 카드의 계좌 정보 업데이트
            const payload = getPayload(data);
            if (payload.updated_strategy) {
                updateStrategyCard(payload.updated_strategy);
            }
        } else {
            showToast('처리 실패: ' + getErrorMessage(data), 'error');
        }
    })
    .catch(error => {
        showToast('처리 중 오류가 발생했습니다: ' + error.message, 'error');
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    });
}

function disconnectAccount(strategyId, accountId) {
    if (confirm('정말로 이 계좌와의 연결을 해제하시겠습니까?')) {
        fetch(`/api/strategies/${strategyId}/accounts/${accountId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(handleApiResponse)
        .then(data => {
            if (data.success) {
                showToast('계좌 연결이 성공적으로 해제되었습니다.', 'success');
                loadStrategyAccountModal(strategyId);
                
                // 전략 카드의 계좌 정보 업데이트
                const payload = getPayload(data);
                if (payload.updated_strategy) {
                    updateStrategyCard(payload.updated_strategy);
                }
            } else {
                showToast('연결 해제 실패: ' + getErrorMessage(data), 'error');
            }
        })
        .catch(error => {
            showToast('연결 해제 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}

function openCapitalModal(strategyId) {
    document.getElementById('capitalModal').classList.remove('hidden');
    loadCapitalModal(strategyId);
}

function closeCapitalModal() {
    document.getElementById('capitalModal').classList.add('hidden');
}

function loadCapitalModal(strategyId) {
    const modalContent = document.getElementById('capitalModalContent');
    modalContent.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">로딩 중...</div></div>';
    
    fetch(`/api/strategies/${strategyId}/accounts`, {
        headers: { 'X-CSRFToken': getCSRFToken() }
    })
    .then(handleApiResponse)
    .then(data => {
        if (data.success) {
            const payload = getPayload(data);
            renderCapitalModal(strategyId, payload.accounts || []);
        } else {
            modalContent.innerHTML = `<div class="text-center py-8 text-error">${getErrorMessage(data, '데이터를 불러오는데 실패했습니다.')}</div>`;
        }
    })
    .catch(error => {
        modalContent.innerHTML = '<div class="text-center py-8 text-error">오류가 발생했습니다: ' + error.message + '</div>';
    });
}

function renderCapitalModal(strategyId, accounts) {
    const modalContent = document.getElementById('capitalModalContent');
    
    let html = `
        <div class="space-y-6">
            <div class="bg-info bg-opacity-10 border border-info rounded-lg p-4">
                <div class="flex items-start">
                    <svg class="h-5 w-5 text-info mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 100-16 8 8 0 000 16zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h4 class="text-sm font-medium text-info">자본 배분 안내</h4>
                        <p class="text-sm text-info mt-1">자본 배분은 계좌 연결 시 자동으로 설정됩니다. 수동 조정은 향후 업데이트에서 지원될 예정입니다.</p>
                    </div>
                </div>
            </div>
    `;
    
    if (accounts.length === 0) {
        html += '<div class="text-center py-8 text-muted">연결된 계좌가 없습니다.</div>';
    } else {
        html += '<div class="space-y-4">';
        
        accounts.forEach(account => {
            const allocated = Number(account.allocated_capital ?? 0);
            const currentPnl = Number(account.current_pnl ?? 0);
            html += `
                <div class="card-inner">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-accent bg-opacity-20 rounded-full flex items-center justify-center">
                                <span class="text-sm font-bold text-accent">${account.exchange.toUpperCase().charAt(0)}</span>
                            </div>
                            <div>
                                <div class="font-medium text-primary">${account.exchange.charAt(0).toUpperCase() + account.exchange.slice(1)} - ${account.name}</div>
                                <div class="text-sm text-muted">가중치: ${account.weight} | 레버리지: ${account.leverage}x</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="badge badge-success">$${allocated.toFixed(2)}</div>
                            <div class="text-sm text-muted mt-1">할당된 자본</div>
                        </div>
                    </div>
                    
                    ${currentPnl !== 0 ? `
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-muted">현재 PnL</span>
                            <span class="badge ${currentPnl >= 0 ? 'badge-success' : 'badge-error'}">
                                ${currentPnl >= 0 ? '+' : ''}$${currentPnl.toFixed(2)}
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';
        
        // 총 할당 자본 표시
        const totalAllocated = accounts.reduce((sum, acc) => sum + (Number(acc.allocated_capital) || 0), 0);
        const totalPnl = accounts.reduce((sum, acc) => sum + (Number(acc.current_pnl) || 0), 0);
        
        html += `
            <div class="border-t border-color pt-4">
                <div class="flex items-center justify-between">
                    <span class="font-medium text-primary">총 할당 자본</span>
                    <span class="badge badge-info">$${totalAllocated.toFixed(2)}</span>
                </div>
                ${totalPnl !== 0 ? `
                    <div class="flex items-center justify-between mt-2">
                        <span class="font-medium text-primary">총 PnL</span>
                        <span class="badge ${totalPnl >= 0 ? 'badge-success' : 'badge-error'}">
                            ${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}
                        </span>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    modalContent.innerHTML = html;
}

function updateStrategyCard(strategy) {
    // 전략 카드의 계좌 정보 업데이트
    const accountsContainer = document.getElementById(`strategy-accounts-${strategy.id}`);
    
    if (accountsContainer) {
        if (strategy.connected_accounts && strategy.connected_accounts.length > 0) {
            let accountsHtml = '';
            strategy.connected_accounts.forEach(account => {
                const allocated = Number(account.allocated_capital ?? 0);
                accountsHtml += `
                    <div class="strategy-account-item">
                        <div class="strategy-account-info">
                            <p>${account.exchange.charAt(0).toUpperCase() + account.exchange.slice(1)} - ${account.name}</p>
                            <p>가중치: ${account.weight} | ${account.max_symbols ? `최대: ${account.max_symbols}개` : '최대: -'} | 레버리지: ${account.leverage}x</p>
                        </div>
                        <div class="strategy-account-amount">
                            <p class="amount tabular-nums">${getCurrencySymbol(account.exchange)}${allocated.toFixed(2)}</p>
                            <p class="currency">USDT${account.exchange === 'upbit' ? ' 환산' : ''}</p>
                        </div>
                    </div>
                `;
            });
            accountsContainer.innerHTML = accountsHtml;
        } else {
            accountsContainer.innerHTML = `
                <div class="text-center py-8 text-muted">
                    <p>연결된 계좌가 없습니다</p>
                </div>
            `;
        }
    }

    // 전략 요약 정보 업데이트
    const strategyCard = document.getElementById(`strategy-card-${strategy.id}`);
    if (strategyCard) {
        const summaryAmount = strategyCard.querySelector('.strategy-summary-card .amount');
        const accountCount = strategyCard.querySelector('.account-count .highlight');
        
        if (summaryAmount) {
            const totalAllocated = Number(strategy.total_allocated_capital ?? 0);
            const firstAccount = strategy.connected_accounts?.[0];
            const currencySymbol = getCurrencySymbol(firstAccount?.exchange || 'BINANCE');
            summaryAmount.textContent = `${currencySymbol}${totalAllocated.toFixed(2)}`;
        }
        if (accountCount) {
            accountCount.textContent = `${strategy.connected_accounts.length}개`;
        }
    }
}

// 전략 토글 이벤트
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.strategy-toggle').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const strategyId = this.dataset.strategyId;
            const isActive = this.checked;
            const toggleElement = this;
            
            fetch(`/api/strategies/${strategyId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(handleApiResponse)
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // 상태 배지 업데이트
                    const strategyCard = document.getElementById(`strategy-card-${strategyId}`);
                    if (strategyCard) {
                        const statusBadge = strategyCard.querySelector('.status-badge');
                        const payload = getPayload(data);
                        const activeState = typeof payload.is_active === 'boolean' ? payload.is_active : isActive;

                        if (statusBadge) {
                            if (activeState) {
                                statusBadge.className = 'status-badge active';
                                statusBadge.innerHTML = '<div class="status-dot active"></div>활성';
                            } else {
                                statusBadge.className = 'status-badge inactive';
                                statusBadge.innerHTML = '<div class="status-dot inactive"></div>비활성';
                            }
                        }
                    }
                } else {
                    showToast('상태 변경 실패: ' + getErrorMessage(data), 'error');
                    // 토글 상태 되돌리기
                    toggleElement.checked = !isActive;
                }
            })
            .catch(error => {
                showToast('상태 변경 중 오류가 발생했습니다: ' + error.message, 'error');
                // 토글 상태 되돌리기
                toggleElement.checked = !isActive;
            });
        });
    });

    // 모달 외부 클릭 시 닫기
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });
    });
    
    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.add('hidden');
            });
        }
    });
});

// @FEAT:capital-management @COMP:ui @TYPE:core
/**
 * 전략 자본 재할당 트리거
 * Phase 5.1: force=true 고정, 2단계 확인 모달 추가
 */
async function triggerCapitalReallocation(event) {
    event.preventDefault();
    
    // 2단계 확인 모달
    const confirmed = confirm(
        "⚠️ 주의: 다음 작업이 즉시 실행됩니다:\n\n" +
        "1. 모든 활성 포지션 무시\n" +
        "2. 거래소별 자본 완전 재할당\n" +
        "3. 기존 설정 덮어쓰기\n\n" +
        "이 작업은 되돌릴 수 없습니다.\n" +
        "계속하시겠습니까?"
    );
    
    if (!confirmed) {
        return;
    }
    
    const button = event.target.closest('button');
    
    // 버튼 비활성화 및 로딩 상태
    button.disabled = true;
    const originalText = button.innerHTML;
    button.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> 재할당 중...';
    
    try {
        const response = await fetch('/api/capital/auto-rebalance-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ force: true })  // 항상 force=true
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || '재할당 실패');
        }
        
        if (data.success) {
            const { total_accounts, rebalanced, skipped, forced } = data.data;
            
            if (total_accounts === 0) {
                showToast('활성 계좌가 없습니다', 'warning');
            } else if (rebalanced > 0) {
                showToast(
                    `${rebalanced}개 계좌 재할당 완료 (강제 실행) - 총 ${total_accounts}개 중 ${skipped}개 건너뜀`,
                    'success'
                );
            } else {
                showToast(
                    `모든 계좌가 조건을 만족하지 않습니다 (${skipped}개 건너뜀)`,
                    'info'
                );
            }
        } else {
            throw new Error(data.error || '알 수 없는 오류');
        }
    } catch (error) {
        console.error('자본 재할당 오류:', error);
        showToast(`재할당 실패: ${error.message}`, 'error');
    } finally {
        // 버튼 복원
        button.disabled = false;
        button.innerHTML = originalText;
    }
}
</script>
{% endblock %} 
