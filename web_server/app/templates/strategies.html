{% extends "base.html" %}

{% block title %}전략 관리 - 트레이딩 자동화 시스템{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/strategies.css') }}">
{% endblock %}

{% block content %}
<div class="space-y-8 page-strategies">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <div class="header-icon">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>전략 관리</h1>
                    <p>트레이딩 전략을 효율적으로 생성, 수정하고 자본을 배분하세요.</p>
                </div>
            </div>
            <!-- @FEAT:capital-management @COMP:ui @TYPE:core -->
            <div class="header-actions">
                <!-- Capital reallocation button moved from tab area to header for improved UX -->
                <button onclick="triggerCapitalReallocation(event)"
                        class="btn btn-warning">
                    <i class="fas fa-sync-alt"></i>
                    전략 자본 재할당
                </button>
                <button onclick="openAddStrategyModal()"
                        class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    새 전략 추가
                </button>
            </div>
        </div>
    </div>

    <!-- 플래시 메시지 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'error' if category == 'error' else 'success' }}">
                    <div class="flex justify-between items-center">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="alert-close">&times;</button>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 탭 내비게이션 -->
    <div class="flex space-x-2 mb-4">
        <button id="tab-my" class="btn btn-secondary btn-sm" onclick="switchTab('my')">내 전략</button>
        <button id="tab-subscribed" class="btn btn-secondary btn-sm" onclick="switchTab('subscribed')">구독 전략</button>
        <button id="tab-discover" class="btn btn-secondary btn-sm" onclick="switchTab('discover')">공개 전략 탐색</button>
    </div>

    <!-- 전략 목록 섹션: 내 전략 (서버 렌더 기본) -->
    <section id="section-my">
        <h2 class="text-2xl font-semibold strategy-title mb-6">내 전략</h2>
        
        {% if strategies %}
            <div class="space-y-8">
                {% for strategy in strategies %}
                <div class="strategy-card-new" id="strategy-card-{{ strategy.id }}">
                    <!-- 전략 카드 헤더 -->
                    <div class="strategy-card-header">
                        <div class="strategy-title-section">
                            <div class="strategy-title-row">
                                <h3>{{ strategy.name }}</h3>
                                <div class="strategy-badges">
                                    <!-- 활성 상태 배지 -->
                                    {% if strategy.is_active %}
                                        <span class="status-badge active" id="status-badge-{{ strategy.id }}">
                                            <div class="status-dot active"></div>
                                            활성
                                        </span>
                                    {% else %}
                                        <span class="status-badge inactive" id="status-badge-{{ strategy.id }}">
                                            <div class="status-dot inactive"></div>
                                            비활성
                                        </span>
                                    {% endif %}
                                    
                                    <!-- 마켓 타입 배지 -->
                                    {% if strategy.market_type == 'FUTURES' %}
                                        <span class="market-type-badge futures">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                                            </svg>
                                            선물
                                        </span>
                                    {% else %}
                                        <span class="market-type-badge spot">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                            현물
                                        </span>
                                    {% endif %}
                                    
                                    <!-- 공개 여부 배지 -->
                                    {% if strategy.is_public %}
                                        <span class="badge badge-accent">공개</span>
                                    {% else %}
                                        <span class="badge badge-secondary">비공개</span>
                                    {% endif %}
                                </div>
                            </div>
                            <p>{{ strategy.description or '단기 변동성 추종 전략 (예시 설명)' }}</p>
                        </div>
                        <div class="strategy-actions-section">
                            <!-- 토글 스위치 -->
                            <label class="toggle-switch-container" title="전략 활성화/비활성화">
                                <input type="checkbox" class="strategy-toggle sr-only" 
                                       data-strategy-id="{{ strategy.id }}" 
                                       {% if strategy.is_active %}checked{% endif %}>
                                <div class="toggle-switch"></div>
                            </label>
                            
                            <!-- 액션 버튼들 -->
                            <button data-strategy-id="{{ strategy.id }}" onclick="editStrategy(this.dataset.strategyId)" 
                                    class="btn-action btn-action-secondary" title="전략 수정">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button data-strategy-id="{{ strategy.id }}" onclick="deleteStrategy(this.dataset.strategyId)" 
                                    class="btn-action btn-action-danger" title="전략 삭제">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- 전략 정보 그리드 -->
                    <div class="strategy-grid-layout">
                        <!-- 전략 요약 -->
                        <div class="strategy-summary-card">
                            <div class="summary-header">
                                <h4>전략 요약</h4>
                            </div>
                            
                            <!-- 주요 지표 -->
                            <div class="summary-main-metrics">
                                <div class="main-metric">
                                    <!-- Phase 4.3: WARNING - Mixed exchange strategies not supported (first account only) -->
                                    {% set first_account = strategy.connected_accounts[0] if strategy.connected_accounts else None %}
                                    <p class="amount tabular-nums">{{ currency_symbol(Exchange, first_account.exchange if first_account else 'BINANCE') }}{{ "%.2f"|format(strategy.total_allocated_capital) }}</p>
                                    <p class="amount-label">총 할당 자본</p>
                                </div>
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon">
                                            <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"/>
                                        </svg>
                                        <div>
                                            <span class="metric-value">{{ strategy.connected_accounts|length }}</span>
                                            <span class="metric-label">연결 계좌</span>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="metric-icon">
                                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <div>
                                            <span class="metric-value">{{ strategy.position_count or 0 }}</span>
                                            <span class="metric-label">포지션</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 빠른 액션 -->
                            <div class="summary-quick-actions">
                                <a href="{{ url_for('main.strategy_positions', strategy_id=strategy.id) }}" 
                                   class="quick-action-btn quick-action-view">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                    </svg>
                                    포지션 보기
                                </a>
                                
                                <button onclick="openAccountModal('{{ strategy.id }}')" 
                                        class="quick-action-btn quick-action-add" 
                                        title="계좌 연동">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                                    </svg>
                                    계좌 연동
                                </button>
                                
                                {% if strategy.connected_accounts %}
                                <button onclick="openCapitalModal('{{ strategy.id }}')" 
                                        class="quick-action-btn quick-action-manage" 
                                        title="자본 관리">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd"/>
                                    </svg>
                                    자본 관리
                                </button>
                                {% else %}
                                <div class="empty-state-hint">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="hint-icon">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>계좌를 연결하여 자동매매를 시작하세요</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- 연결된 계좌 및 자본 배분 -->
                        <div class="strategy-accounts-section">
                            <h4>연결된 계좌 및 자본 배분</h4>
                            <div class="strategy-accounts-list" id="strategy-accounts-{{ strategy.id }}">
                                {% if strategy.connected_accounts %}
                                    {% for account in strategy.connected_accounts %}
                                    <div class="strategy-account-item">
                                        <div class="strategy-account-info">
                                            <p>{{ account.exchange.title() }} - {{ account.name }}</p>
                                            <p>가중치: {{ account.weight }} | {% if account.max_symbols %}최대: {{ account.max_symbols }}개{% else %}최대: -{% endif %} | 레버리지: {{ account.leverage }}x</p>
                                        </div>
                                        <div class="strategy-account-amount">
                                            <p class="amount tabular-nums">{{ currency_symbol(Exchange, account.exchange) }}{{ "%.2f"|format(account.allocated_capital) }}</p>
                                            <p class="currency">USDT{% if account.exchange == 'upbit' %} 환산{% endif %}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center py-8 text-muted">
                                        <p>연결된 계좌가 없습니다</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="mx-auto w-24 h-24 bg-gradient-to-r from-purple-100 to-blue-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-primary mb-2">등록된 전략이 없습니다</h3>
                <p class="text-muted mb-6">첫 번째 트레이딩 전략을 추가하여 시작하세요.</p>
                <button onclick="openAddStrategyModal()" 
                        class="btn btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    첫 번째 전략 추가
                </button>
            </div>
        {% endif %}
    </section>

    <!-- 전략 목록 섹션: 구독 전략 (클라이언트 렌더) -->
    <section id="section-subscribed" class="hidden">
        <h2 class="text-2xl font-semibold strategy-title mb-6">구독 전략</h2>
        <div id="subscribed-strategies" class="space-y-8"></div>
    </section>

    <!-- 전략 목록 섹션: 공개 전략 탐색 (클라이언트 렌더) -->
    <section id="section-discover" class="hidden">
        <h2 class="text-2xl font-semibold strategy-title mb-6">공개 전략 탐색</h2>
        <div id="public-strategies" class="space-y-4"></div>
    </section>
</div>

<!-- 토스트 컨테이너 -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- 전략 추가/수정 모달 -->
<div id="strategyModal" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-accent rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 id="strategyModalTitle" class="text-lg font-semibold text-primary">전략 추가</h3>
            </div>
            <button onclick="closeStrategyModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="strategyForm" onsubmit="submitStrategy(event)">
                <input type="hidden" id="strategyId" name="strategy_id">
                
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="name" class="form-label">전략명</label>
                        <input type="text" id="name" name="name" required class="form-input" placeholder="예: RSI 역추세 전략">
                    </div>
                    
                    <div class="form-group">
                        <label for="description" class="form-label">설명</label>
                        <textarea id="description" name="description" rows="3" class="form-textarea" placeholder="전략에 대한 설명을 입력하세요"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="group_name" class="form-label">그룹명</label>
                        <input type="text" id="group_name" name="group_name" class="form-input" placeholder="예: 역추세 전략군">
                    </div>
                    
                    <div class="form-group">
                        <label for="market_type" class="form-label">마켓 타입</label>
                        <select id="market_type" name="market_type" required class="form-select">
                            <option value="">선택하세요</option>
                            <option value="spot">현물</option>
                            <option value="futures">선물</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="is_active" name="is_active" 
                               class="rounded border-color text-accent shadow-sm focus:border-accent focus:ring focus:ring-accent focus:ring-opacity-50">
                        <label for="is_active" class="ml-2 text-sm text-primary">전략 활성화</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="is_public" name="is_public" 
                               class="rounded border-color text-accent shadow-sm focus:border-accent focus:ring focus:ring-accent focus:ring-opacity-50">
                        <label for="is_public" class="ml-2 text-sm text-primary">공개 전략</label>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeStrategyModal()" 
                            class="btn btn-secondary flex-1">
                        취소
                    </button>
                    <button type="submit" 
                            class="btn btn-primary flex-1">
                        저장
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 계좌 연결 모달 -->
<div id="accountModal" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-accent rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-primary">공개 전략 구독</h3>
            </div>
            <button onclick="closeAccountModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="accountModalContent">
                <!-- 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>
</div>

<!-- 자본 배분 모달 -->
<div id="capitalModal" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
        <div class="modal-header">
            <div class="flex items-center">
                <div class="bg-success rounded-full p-2 mr-3">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.51-1.31c-.562-.649-1.413-1.076-2.353-1.253V5z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-primary">자본 배분 관리</h3>
            </div>
            <button onclick="closeCapitalModal()" class="modal-close">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        
        <div class="modal-body">
            <div id="capitalModalContent">
                <!-- 동적으로 로드됩니다 -->
            </div>
        </div>
    </div>
</div>

<script>
// @FEAT:futures-validation @COMP:route @TYPE:validation
// 전략 데이터를 전역 변수로 설정 (Jinja2 렌더링 - 서버에서 동적 생성)
// NOTE: This must stay in strategies.html (cannot move to strategies.js due to Jinja2 template syntax)
window.strategies = [
    {% for strategy in strategies %}
    {
        id: {{ strategy.id }},
        name: '{{ strategy.name }}',
        market_type: '{{ strategy.market_type }}',
        is_active: {{ 'true' if strategy.is_active else 'false' }},
        is_public: {{ 'true' if strategy.is_public else 'false' }},
        description: '{{ strategy.description or '' }}'
    }{{ ',' if not loop.last else '' }}
    {% endfor %}
];
</script>

<!-- Core utilities (먼저 로드) -->
<script src="{{ url_for('static', filename='js/strategies/strategies-core.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-rendering.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-api.js') }}"></script>

<!-- UI management -->
<script src="{{ url_for('static', filename='js/strategies/strategies-modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-ui.js') }}"></script>

<!-- Business logic -->
<script src="{{ url_for('static', filename='js/strategies/strategies-data.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-subscription.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-crud.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-accounts.js') }}"></script>
<script src="{{ url_for('static', filename='js/strategies/strategies-capital.js') }}"></script>

<!-- Event listeners (반드시 마지막) -->
<script src="{{ url_for('static', filename='js/strategies/strategies-events.js') }}"></script>
{% endblock %}
