{% extends "base.html" %}

{% block title %}{{ user.username }} í…”ë ˆê·¸ë¨ ì„¤ì • - íŠ¸ë ˆì´ë”© ìë™í™” ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header bg-gradient-to-r from-blue-600 to-purple-600">
        <div class="header-content">
            <div class="header-info">
                <div class="header-icon bg-white/20">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 496 512">
                        <path d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/>
                    </svg>
                </div>
                <div class="header-text">
                    <h1 class="text-3xl font-bold">{{ user.username }} í…”ë ˆê·¸ë¨ ì„¤ì •</h1>
                    <p class="text-white/80 mt-1">ì‚¬ìš©ìì˜ í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                </div>
            </div>
            <div class="header-actions">
                <a href="{{ url_for('admin.users') }}" class="btn btn-white/20 hover:bg-white/30 text-white border-white/30">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    ì‚¬ìš©ì ëª©ë¡ìœ¼ë¡œ
                </a>
            </div>
        </div>
    </div>

    <!-- ì‚¬ìš©ì ì •ë³´ ì¹´ë“œ -->
    <div class="card">
        <div class="px-6 py-4 border-b border-color">
            <h2 class="text-xl font-semibold text-primary flex items-center">
                <svg class="w-5 h-5 mr-2 text-info" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                </svg>
                ì‚¬ìš©ì ì •ë³´
            </h2>
            <p class="text-sm text-secondary mt-1">í˜„ì¬ ì‚¬ìš©ìì˜ ê¸°ë³¸ ì •ë³´ì…ë‹ˆë‹¤</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="text-sm font-medium text-muted">ì‚¬ìš©ìëª…</label>
                    <p class="text-lg font-semibold text-primary mt-1">{{ user.username }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-muted">ì´ë©”ì¼</label>
                    <p class="text-lg font-semibold text-primary mt-1">{{ user.email or 'ì„¤ì •ë˜ì§€ ì•ŠìŒ' }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-muted">ìƒíƒœ</label>
                    <div class="mt-1">
                        <span class="badge {{ 'badge-success' if user.is_active else 'badge-warning' }}">
                            <div class="w-1.5 h-1.5 {{ 'bg-green-400' if user.is_active else 'bg-yellow-400' }} rounded-full mr-1.5"></div>
                            {{ 'í™œì„±' if user.is_active else 'ë¹„í™œì„±' }}
                        </span>
                        {% if user.is_admin %}
                        <span class="badge badge-accent ml-2">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                            </svg>
                            ê´€ë¦¬ì
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í…”ë ˆê·¸ë¨ ì„¤ì • í¼ -->
    <form method="POST" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="card">
            <div class="px-6 py-4 border-b border-color">
                <h2 class="text-xl font-semibold text-primary flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 496 512">
                        <path d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/>
                    </svg>
                    í…”ë ˆê·¸ë¨ ì„¤ì •
                </h2>
                <p class="text-sm text-secondary mt-1">ì‚¬ìš©ìì˜ í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="form-group">
                    <label for="telegram_id" class="block text-sm font-medium text-gray-700 mb-2">í…”ë ˆê·¸ë¨ Chat ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="telegram_id" name="telegram_id" 
                               value="{{ user.telegram_id or '' }}" 
                               class="form-input flex-1" 
                               placeholder="ì˜ˆ: 123456789">
                        <button type="button" id="testTelegramBtn" 
                                onclick="testTelegramConnection({{ user.id }})"
                                class="btn btn-info"
                                {% if not user.telegram_id %}disabled{% endif %}>
                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            í…ŒìŠ¤íŠ¸
                        </button>
                    </div>
                    <div class="mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md">
                        <p class="text-sm text-blue-800 dark:text-blue-300">
                            <strong>ğŸ’¡ ì„¤ì • ë°©ë²•:</strong> ì‚¬ìš©ìì—ê²Œ í…”ë ˆê·¸ë¨ì—ì„œ @userinfobotì„ ê²€ìƒ‰í•˜ì—¬ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ê³ , /start ëª…ë ¹ì–´ë¥¼ ë³´ë‚´ë©´ ë°›ì„ ìˆ˜ ìˆëŠ” ID ìˆ«ìë¥¼ ì…ë ¥í•˜ë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.
                        </p>
                    </div>
                </div>

                <!-- í…”ë ˆê·¸ë¨ ì—°ê²° ìƒíƒœ -->
                <div id="telegramStatus" class="hidden"></div>
            </div>
        </div>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="flex justify-end gap-3">
            <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                ì·¨ì†Œ
            </a>
            <button type="submit" class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                ì„¤ì • ì €ì¥
            </button>
        </div>
    </form>

    <!-- ê´€ë¦¬ì ë„êµ¬ -->
    {% if user.telegram_id %}
    <div class="card">
        <div class="px-6 py-4 border-b border-color">
            <h2 class="text-xl font-semibold text-primary flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                ê´€ë¦¬ì ë„êµ¬
            </h2>
            <p class="text-sm text-secondary mt-1">ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì•Œë¦¼ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>
        
        <div class="p-6">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-primary mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    ì•Œë¦¼ ì „ì†¡
                </h3>
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="notificationTitle" class="block text-sm font-medium text-gray-700 mb-2">ì œëª©</label>
                        <input type="text" id="notificationTitle" 
                               class="form-input" 
                               placeholder="ì•Œë¦¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                               value="ê´€ë¦¬ì ì•Œë¦¼">
                    </div>
                    
                    <div class="form-group">
                        <label for="notificationMessage" class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€</label>
                        <textarea id="notificationMessage" 
                                  class="form-input" 
                                  rows="4"
                                  placeholder="ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                    </div>
                    
                    <button type="button" 
                            onclick="sendNotification({{ user.id }})"
                            class="btn btn-primary">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                        ì•Œë¦¼ ì „ì†¡
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
// Toast í•¨ìˆ˜ë“¤
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    toast.innerHTML = `
        <div class="toast-content">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="toast-close">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'fixed top-4 right-4 z-50 space-y-2';
    document.body.appendChild(container);
    return container;
}

// CSRF í† í°
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// ê´€ë¦¬ì ê²€ì¦ ë˜í¼ ë° ëª¨ë‹¬
let _adminVerifyResolve = null;
function openAdminVerifyModal() {
    const existing = document.getElementById('adminVerifyModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = 'adminVerifyModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
    <div class="modal-content max-w-md">
        <div class="modal-header">
            <h3 class="text-lg font-semibold text-primary">ê´€ë¦¬ì í™•ì¸</h3>
            <button onclick="closeAdminVerifyModal()" class="modal-close">âœ•</button>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-muted">ë¯¼ê°í•œ ì‘ì—…ì…ë‹ˆë‹¤. ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input id="adminVerifyPassword" type="password" class="form-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" />
                <p id="adminVerifyError" class="text-sm text-red-600 mt-2 hidden"></p>
            </div>
            <div class="flex justify-end gap-2">
                <button class="btn btn-secondary" onclick="closeAdminVerifyModal()">ì·¨ì†Œ</button>
                <button id="adminVerifySubmit" class="btn btn-primary" onclick="submitAdminVerification()">í™•ì¸</button>
            </div>
        </div>
    </div>`;
    document.body.appendChild(modal);
    setTimeout(() => document.getElementById('adminVerifyPassword')?.focus(), 0);
}
function closeAdminVerifyModal() {
    const modal = document.getElementById('adminVerifyModal');
    if (modal) modal.remove();
    if (_adminVerifyResolve) { _adminVerifyResolve(false); _adminVerifyResolve = null; }
}
function submitAdminVerification() {
    const password = document.getElementById('adminVerifyPassword').value;
    const btn = document.getElementById('adminVerifySubmit');
    const err = document.getElementById('adminVerifyError');
    btn.disabled = true; btn.innerText = 'í™•ì¸ ì¤‘...'; err.classList.add('hidden');
    fetch('/admin/verify-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ password })
    }).then(r => r.json().then(d => ({ ok: r.ok, data: d }))).then(({ ok, data }) => {
        if (ok && data.success) {
            const modal = document.getElementById('adminVerifyModal');
            if (modal) modal.remove();
            if (_adminVerifyResolve) { _adminVerifyResolve(true); _adminVerifyResolve = null; }
        } else {
            err.textContent = data?.message || 'ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; err.classList.remove('hidden');
        }
    }).catch(() => {
        err.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; err.classList.remove('hidden');
    }).finally(() => { btn.disabled = false; btn.innerText = 'í™•ì¸'; });
}
function ensureAdminVerified() {
    return new Promise((resolve) => { _adminVerifyResolve = resolve; openAdminVerifyModal(); });
}
async function adminFetch(input, init = {}) {
    const first = await fetch(input, init);
    if (first.status === 401 || first.status === 403) {
        try {
            const body = await first.clone().json();
            if (body && body.require_admin_verification) {
                const verified = await ensureAdminVerified();
                if (!verified) return first;
                return fetch(input, init);
            }
        } catch (_) {}
    }
    return first;
}

// í…”ë ˆê·¸ë¨ ì—°ê²° í…ŒìŠ¤íŠ¸
function testTelegramConnection(userId) {
    const telegramId = document.getElementById('telegram_id').value.trim();
    const testBtn = document.getElementById('testTelegramBtn');
    const statusDiv = document.getElementById('telegramStatus');
    
    if (!telegramId) {
        showToast('í…”ë ˆê·¸ë¨ IDë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.', 'error');
        return;
    }
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ
    testBtn.disabled = true;
    testBtn.innerHTML = '<div class="loading-spinner"></div>í…ŒìŠ¤íŠ¸ ì¤‘...';
    
    adminFetch(`/admin/users/${userId}/test-telegram`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        statusDiv.classList.remove('hidden');
        
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span>âœ… ${data.message}</span>
                    </div>
                </div>
            `;
            showToast('í…”ë ˆê·¸ë¨ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-error">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <span>âŒ ${data.message}</span>
                    </div>
                </div>
            `;
            showToast(`í…”ë ˆê·¸ë¨ ì—°ê²° ì‹¤íŒ¨: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = `
            <div class="alert alert-error">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <span>âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
        `;
        showToast('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    })
    .finally(() => {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        testBtn.disabled = false;
        testBtn.innerHTML = 'í…ŒìŠ¤íŠ¸';
    });
}

// ì•Œë¦¼ ì „ì†¡
function sendNotification(userId) {
    const title = document.getElementById('notificationTitle').value.trim();
    const message = document.getElementById('notificationMessage').value.trim();
    
    if (!message) {
        showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
    }
    
    adminFetch(`/admin/users/${userId}/send-telegram-notification`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            title: title,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // ë©”ì‹œì§€ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('notificationMessage').value = '';
        } else {
            showToast(`ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showToast('ì•Œë¦¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    });
}

// í…”ë ˆê·¸ë¨ ID ì…ë ¥ ì‹œ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
document.getElementById('telegram_id').addEventListener('input', function() {
    const testBtn = document.getElementById('testTelegramBtn');
    const statusDiv = document.getElementById('telegramStatus');
    
    if (this.value.trim()) {
        testBtn.disabled = false;
    } else {
        testBtn.disabled = true;
        statusDiv.classList.add('hidden');
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const telegramId = document.getElementById('telegram_id').value.trim();
    const testBtn = document.getElementById('testTelegramBtn');
    
    if (telegramId) {
        testBtn.disabled = false;
    }
});
</script>
{% endblock %}