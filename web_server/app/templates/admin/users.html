{% extends "base.html" %}

{% block title %}사용자 관리 - 관리자{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <div class="header-icon">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                    </svg>
                </div>
                <div class="header-text">
                    <h1>사용자 관리</h1>
                    <p>시스템 사용자를 관리하고 권한을 설정하세요</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2">
                    <span class="text-sm font-medium">총 {{ users|length }}명</span>
                </div>
                {% if pending_users|length > 0 %}
                <div class="bg-yellow-100 rounded-lg px-4 py-2">
                    <span class="text-sm font-medium">승인 대기 {{ pending_users|length }}명</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 플래시 메시지 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            {% if category == 'error' %}
                                <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            {% else %}
                                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">
                                {{ message }}
                            </p>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- 시스템 통계 카드 -->
    <div class="stats-grid">
        <!-- 승인된 사용자 -->
        <div class="stats-card">
            <div class="stats-content">
                <div class="stats-info">
                    <h3>승인된 사용자</h3>
                    <p class="stats-value text-success">{{ approved_users_count or 0 }}</p>
                    <p class="stats-subtitle">활성 계정</p>
                </div>
                <div class="stats-icon bg-green-100">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 승인 대기 -->
        <div class="stats-card">
            <div class="stats-content">
                <div class="stats-info">
                    <h3>승인 대기</h3>
                    <p class="stats-value text-warning">{{ pending_users_count or 0 }}</p>
                    <p class="stats-subtitle">대기 중</p>
                </div>
                <div class="stats-icon bg-yellow-100">
                    <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 관리자 -->
        <div class="stats-card">
            <div class="stats-content">
                <div class="stats-info">
                    <h3>관리자</h3>
                    <p class="stats-value text-accent">{{ admin_users_count or 0 }}</p>
                    <p class="stats-subtitle">관리 권한</p>
                </div>
                <div class="stats-icon bg-purple-100">
                    <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- 승인 대기 사용자 -->
    {% if pending_users %}
    <div class="card">
        <div class="px-6 py-4 border-b border-color">
            <h2 class="text-xl font-semibold text-primary flex items-center">
                <svg class="w-5 h-5 mr-2 text-warning" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                승인 대기 사용자
            </h2>
            <p class="text-sm text-secondary mt-1">새로 가입한 사용자들의 승인을 관리하세요</p>
        </div>
        <div class="p-6">
            <div class="overflow-x-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>사용자</th>
                            <th>이메일</th>
                            <th>가입일</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in pending_users %}
                        <tr>
                            <td>
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10">
                                        <div class="h-10 w-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                            <span class="text-sm font-medium text-yellow-700">{{ user.username[0].upper() }}</span>
                                        </div>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-primary">{{ user.username }}</div>
                                        <div class="text-sm text-muted">{{ user.telegram_id or '텔레그램 미설정' }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-sm text-primary">{{ user.email }}</td>
                            <td class="text-sm text-muted">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <div class="flex space-x-2">
                                    <button onclick="approveUser({{ user.id }})" 
                                            class="btn btn-success btn-sm">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                        </svg>
                                        승인
                                    </button>
                                    <button onclick="rejectUser({{ user.id }})" 
                                            class="btn btn-error btn-sm">
                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                        </svg>
                                        거부
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 전체 사용자 목록 -->
    <div class="card">
        <div class="px-6 py-4 border-b border-color">
            <h2 class="text-xl font-semibold text-primary flex items-center">
                <svg class="w-5 h-5 mr-2 text-info" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                전체 사용자 목록
            </h2>
            <p class="text-sm text-secondary mt-1">등록된 모든 사용자를 관리하고 권한을 설정하세요</p>
        </div>
        <div class="p-6">
            {% if users %}
                <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>사용자</th>
                                <th>이메일</th>
                                <th>상태</th>
                                <th>권한</th>
                                <th>마지막 로그인</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 {{ 'bg-green-100' if user.is_active else 'bg-gray-300' }} rounded-full flex items-center justify-center">
                                                <span class="text-sm font-medium {{ 'text-green-700' if user.is_active else 'text-gray-700' }}">{{ user.username[0].upper() }}</span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-primary">{{ user.username }}</div>
                                            <div class="text-sm text-muted">{{ user.telegram_id or '텔레그램 미설정' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-sm text-primary">{{ user.email }}</td>
                                <td>
                                    {% if user.is_active %}
                                        <span class="badge badge-success">
                                            <div class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></div>
                                            승인됨
                                        </span>
                                    {% else %}
                                        <span class="badge badge-warning">
                                            <div class="w-1.5 h-1.5 bg-yellow-400 rounded-full mr-1.5"></div>
                                            승인 대기
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.is_admin %}
                                        <span class="badge badge-accent">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                                            </svg>
                                            관리자
                                        </span>
                                    {% else %}
                                        <span class="badge badge-info">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"></path>
                                            </svg>
                                            일반 사용자
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-sm text-muted">
                                    {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else '없음' }}
                                </td>
                                <td>
                                    {% if user.id != current_user.id %}
                                    <div class="flex flex-wrap gap-2">
                                        {% if not user.is_active %}
                                            <button onclick="approveUser({{ user.id }})" 
                                                    class="btn btn-success btn-sm">
                                                승인
                                            </button>
                                            <button onclick="rejectUser({{ user.id }})" 
                                                    class="btn btn-error btn-sm">
                                                거부
                                            </button>
                                        {% endif %}
                                        {% if not user.is_admin %}
                                            <button onclick="toggleAdmin({{ user.id }})" 
                                                    class="btn btn-accent btn-sm">
                                                관리자 권한
                                            </button>
                                        {% endif %}
                                        <a href="{{ url_for('admin.user_telegram_settings', user_id=user.id) }}" 
                                           class="btn btn-secondary btn-sm">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 496 512">
                                                <path d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/>
                                            </svg>
                                            텔레그램
                                        </a>
                                        <button onclick="resetPassword({{ user.id }})" 
                                                class="btn btn-primary btn-sm">
                                            비밀번호 초기화
                                        </button>
                                        <button onclick="deleteUser({{ user.id }})" 
                                                class="btn btn-error btn-sm">
                                            삭제
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="badge badge-secondary">
                                        본인 계정
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-primary">등록된 사용자가 없습니다</h3>
                    <p class="mt-1 text-sm text-muted">아직 등록된 사용자가 없습니다.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 알림 모달 -->
<div id="notification" class="toast hidden">
    <div class="toast-content">
        <div class="flex items-center">
            <div id="notification-icon" class="flex-shrink-0 mr-3"></div>
            <div>
                <p id="notification-message" class="text-sm font-medium"></p>
            </div>
        </div>
    </div>
</div>

<!-- 비밀번호 초기화 모달 -->
<div id="passwordResetModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <!-- 헤더 -->
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-blue-100 rounded-full p-2 mr-3">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-primary">비밀번호 초기화 완료</h3>
                </div>
                <button onclick="closePasswordModal()" class="modal-close">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="modal-body">
            <!-- 사용자 정보 -->
            <div class="bg-secondary rounded-lg p-4 mb-4">
                <p class="text-sm text-muted mb-1">사용자</p>
                <p id="resetUserName" class="font-medium text-primary"></p>
            </div>
            
            <!-- 임시 비밀번호 -->
            <div class="form-group">
                <label class="form-label">임시 비밀번호</label>
                <div class="relative">
                    <input type="text" id="tempPassword" readonly 
                           class="form-input font-mono text-lg text-center">
                    <button onclick="copyPassword()" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 btn btn-primary btn-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                            <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                        </svg>
                        복사
                    </button>
                </div>
                <p class="form-help">이 비밀번호를 사용자에게 안전하게 전달해주세요.</p>
            </div>
            
            <!-- 주의사항 -->
            <div class="alert alert-warning">
                <div class="flex">
                    <svg class="w-5 h-5 text-warning mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h4 class="text-sm font-medium">보안 주의사항</h4>
                        <ul class="text-xs mt-1 space-y-1">
                            <li>• 사용자가 첫 로그인 시 비밀번호를 변경하도록 안내하세요</li>
                            <li>• 임시 비밀번호는 안전한 방법으로 전달하세요</li>
                            <li>• 이 창을 닫으면 비밀번호를 다시 확인할 수 없습니다</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 버튼 -->
            <div class="flex space-x-3 mt-6">
                <button onclick="copyPassword()" 
                        class="btn btn-primary flex-1">
                    <svg class="w-4 h-4 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                    </svg>
                    비밀번호 복사
                </button>
                <button onclick="closePasswordModal()" 
                        class="btn btn-secondary flex-1">
                    확인
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// 관리자 세션 검증 모달
let _adminVerifyResolve = null;
function openAdminVerifyModal() {
    const existing = document.getElementById('adminVerifyModal');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.id = 'adminVerifyModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
    <div class="modal-content max-w-md">
        <div class="modal-header">
            <h3 class="text-lg font-semibold text-primary">관리자 확인</h3>
            <button onclick="closeAdminVerifyModal()" class="modal-close">✕</button>
        </div>
        <div class="p-6 space-y-4">
            <p class="text-sm text-muted">민감한 작업입니다. 관리자 비밀번호를 입력해주세요.</p>
            <div class="form-group">
                <label class="form-label">비밀번호</label>
                <input id="adminVerifyPassword" type="password" class="form-input" placeholder="현재 비밀번호" />
                <p id="adminVerifyError" class="text-sm text-red-600 mt-2 hidden"></p>
            </div>
            <div class="flex justify-end gap-2">
                <button class="btn btn-secondary" onclick="closeAdminVerifyModal()">취소</button>
                <button id="adminVerifySubmit" class="btn btn-primary" onclick="submitAdminVerification()">확인</button>
            </div>
        </div>
    </div>`;
    document.body.appendChild(modal);
    setTimeout(() => document.getElementById('adminVerifyPassword')?.focus(), 0);
}
function closeAdminVerifyModal() {
    const modal = document.getElementById('adminVerifyModal');
    if (modal) modal.remove();
    if (_adminVerifyResolve) { _adminVerifyResolve(false); _adminVerifyResolve = null; }
}
function submitAdminVerification() {
    const password = document.getElementById('adminVerifyPassword').value;
    const btn = document.getElementById('adminVerifySubmit');
    const err = document.getElementById('adminVerifyError');
    btn.disabled = true; btn.innerText = '확인 중...'; err.classList.add('hidden');
    fetch('/admin/verify-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify({ password })
    }).then(r => r.json().then(d => ({ ok: r.ok, data: d }))).then(({ ok, data }) => {
        if (ok && data.success) {
            const modal = document.getElementById('adminVerifyModal');
            if (modal) modal.remove();
            if (_adminVerifyResolve) { _adminVerifyResolve(true); _adminVerifyResolve = null; }
        } else {
            err.textContent = data?.message || '검증에 실패했습니다.'; err.classList.remove('hidden');
        }
    }).catch(() => {
        err.textContent = '네트워크 오류가 발생했습니다.'; err.classList.remove('hidden');
    }).finally(() => { btn.disabled = false; btn.innerText = '확인'; });
}
function ensureAdminVerified() {
    return new Promise((resolve) => { _adminVerifyResolve = resolve; openAdminVerifyModal(); });
}

// 관리자 검증 자동 재시도 래퍼
async function adminFetch(input, init = {}) {
    const first = await fetch(input, init);
    if (first.status === 401 || first.status === 403) {
        try {
            const body = await first.clone().json();
            if (body && body.require_admin_verification) {
                const verified = await ensureAdminVerified();
                if (!verified) return first; // 취소 시 원 응답 반환
                // 재시도
                return fetch(input, init);
            }
        } catch (_) {
            // 본문이 JSON이 아닐 때는 그대로 반환
        }
    }
    return first;
}
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const messageEl = document.getElementById('notification-message');
    const iconEl = document.getElementById('notification-icon');
    
    messageEl.textContent = message;
    
    // 아이콘 설정
    if (type === 'success') {
        iconEl.innerHTML = '<div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg></div>';
        notification.className = 'toast success';
    } else if (type === 'error') {
        iconEl.innerHTML = '<div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg></div>';
        notification.className = 'toast error';
    } else {
        iconEl.innerHTML = '<div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></div>';
        notification.className = 'toast info';
    }
    
    notification.classList.remove('hidden');
    
    // 3초 후 자동 숨김
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 3000);
}

function showPasswordResetModal(userName, tempPassword) {
    document.getElementById('resetUserName').textContent = userName;
    document.getElementById('tempPassword').value = tempPassword;
    document.getElementById('passwordResetModal').classList.remove('hidden');
}

function closePasswordModal() {
    document.getElementById('passwordResetModal').classList.add('hidden');
}

function copyPassword() {
    const passwordInput = document.getElementById('tempPassword');
    passwordInput.select();
    passwordInput.setSelectionRange(0, 99999); // 모바일 지원
    
    try {
        document.execCommand('copy');
        showNotification('임시 비밀번호가 클립보드에 복사되었습니다!', 'success');
        
        // 복사 버튼 피드백
        const copyButtons = document.querySelectorAll('button[onclick="copyPassword()"]');
        copyButtons.forEach(button => {
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>복사됨!';
            button.classList.add('btn-success');
            button.classList.remove('btn-primary');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
        });
    } catch (err) {
        showNotification('복사에 실패했습니다. 수동으로 복사해주세요.', 'error');
    }
}

// 모달 외부 클릭 시 닫기
document.getElementById('passwordResetModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePasswordModal();
    }
});

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePasswordModal();
    }
});

function approveUser(userId) {
    if (confirm('이 사용자를 승인하시겠습니까?')) {
        adminFetch(`/admin/users/${userId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('승인 중 오류가 발생했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('승인 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}

function rejectUser(userId) {
    if (confirm('이 사용자의 가입을 거부하시겠습니까? 계정이 삭제됩니다.')) {
        adminFetch(`/admin/users/${userId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('거부 중 오류가 발생했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('거부 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}

function toggleAdmin(userId) {
    if (confirm('이 사용자의 관리자 권한을 변경하시겠습니까?')) {
        adminFetch(`/admin/users/${userId}/toggle-admin`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('권한 변경 중 오류가 발생했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('권한 변경 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}

function resetPassword(userId) {
    if (confirm('이 사용자의 비밀번호를 초기화하시겠습니까? 임시 비밀번호가 생성됩니다.')) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        // 로딩 상태
        button.disabled = true;
        button.innerHTML = '<svg class="animate-spin w-3 h-3 inline mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>처리중...';
        
        adminFetch(`/admin/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 사용자 이름 찾기
                const userRow = button.closest('tr');
                const userName = userRow.querySelector('.text-sm.font-medium.text-primary').textContent;
                
                // 모달로 비밀번호 표시
                showPasswordResetModal(userName, data.temp_password);
                showNotification('비밀번호가 성공적으로 초기화되었습니다.', 'success');
            } else {
                showNotification('비밀번호 초기화 중 오류가 발생했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('비밀번호 초기화 중 오류가 발생했습니다: ' + error.message, 'error');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
}

function deleteUser(userId) {
    if (confirm('정말로 이 사용자를 삭제하시겠습니까? 모든 관련 데이터가 삭제됩니다.')) {
        adminFetch(`/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('삭제 중 오류가 발생했습니다: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showNotification('삭제 중 오류가 발생했습니다: ' + error.message, 'error');
        });
    }
}
</script>
{% endblock %} 
