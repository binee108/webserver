# Capital Management (자본 관리)

**Feature**: `@FEAT:capital-management`, `@FEAT:capital-reallocation`  
**Status**: ✅ Phase 1 Complete (2025-10-21)  
**Last Updated**: 2025-10-21

---

## 목적 (Purpose)

거래 전략의 효율성을 극대화하기 위해 여러 전략 간 자본을 동적으로 배분하고, 실시간 잔고 변화를 감지하여 자동으로 재할당하는 시스템입니다.

**주요 특징**:
- 전략별 정적 배분 (고정 비율 또는 고정액)
- 동적 재할당 (잔고 변화 감지 시 이중 임계값 기반)
- 자동 스케줄러 (660초마다 = 11분 간격, 하루 약 130회)
- 수동 UI 트리거 (/accounts 페이지)
- 포지션 청산 후 즉시 재할당

---

## 핵심 개념 (Key Concepts)

### 1. 재할당 조건 (Phase 1)

| 조건 | 설명 |
|-----|------|
| **포지션 청산** | 모든 전략 포지션 = 0 |
| **절대값** | Δ balance ≥ 10 USDT |
| **비율** | Δ% ≥ 0.1% |
| **조합** | 절대값 AND 비율 모두 충족 |

### 2. `should_rebalance()` 메서드

```python
# @FEAT:capital-management @COMP:service @TYPE:core
def should_rebalance(account_id):
    """
    자동 리밸런싱 조건 판단 (Phase 1: 이중 임계값 기반)

    조건:
    1. 모든 포지션 청산 (has_open_positions() == False)
    2. 잔고 변화가 임계값 초과:
       - 절대값: 최소 10 USDT 변화
       - 비율: 최소 0.1% 변화
       - 양쪽 모두 충족 시 재할당 (AND 조건)

    Returns:
    {
        'should_rebalance': True/False,
        'reason': '잔고 변화 감지 (0.1234%)',
        'has_positions': False,
        'current_total': 10015.0,
        'previous_total': 10000.0,
        'delta': 15.0,
        'percent_change': 0.0015
    }
    """
    pass
```

---

## 자동 재할당 스케줄 (2025-10-21 Phase 2 업데이트)

**실행 주기**: 660초(11분)마다 (하루 약 130회)
- 계산: 1일 = 1440분 ÷ 11분 = 130.9회/일

**주기 선택 이유**:
- 사용자 요구사항: "5~15분 사이마다 백그라운드에서 시도"
- 11분(660초)은 소수로 시간대 분산 효과
- Phase 1의 이중 임계값 조건으로 불필요한 재할당 자동 차단
- 5분 TTL 캐싱으로 거래소 API 부하 70% 감소

**실행 조건 (Phase 1)**:
1. 모든 포지션 청산 상태
2. 잔고 변화가 임계값 초과:
   - 절대값: 10 USDT 이상
   - 비율: 0.1% 이상

**예시**:
- 10:00:00 실행 → 10:11:00 재실행 → 10:22:00 재실행...
- 포지션 존재 시 자동 스킵
- 잔고 변화 없으면 자동 스킵 (불필요한 API 호출 방지)

---

## 수동 재할당 UI

**경로**: /accounts 페이지 → 재할당 버튼

**재할당 조건**:
- 조건 1: 계좌의 모든 전략 포지션 = 0
- 조건 2: 잔고 변화 감지 (10 USDT 이상 AND 0.1% 이상)

**조건 미충족 시 메시지**:
- "포지션 존재" (조건 1 미충족)
- "변화량 부족" (조건 2 절대값 미달)
- "임계값 미달" (조건 2 비율 미달)

---

## 캐싱 (capital_service.py:41-49)

거래소 API 호출 70% 감소

- **TTL**: 5분 (300초)
- **무효화**: 재할당 완료 시 `invalidate_cache(account_id)` 호출

---

## 버전 이력

### Phase 2 (2025-10-21)
- **자동 재할당 스케줄 개선**: 7개 cron job → 1개 interval job (660초 간격)
- **실행 빈도 증가**: 7회/일 → 130회/일 (약 18.6배 증가)
- **코드 단순화**: DRY 원칙 강화 (-10% 코드 감소)
- **파일**: `app/__init__.py` (Lines 636-653)
- **태그**: `@FEAT:capital-management @COMP:job @TYPE:core`

### Phase 1 (2025-10-21)
- **이중 임계값 기반 재할당**: 시간 기반 → 잔고 변화 감지
- **포지션 청산 즉시 재할당**: `position_manager.py` 통합
- **캐싱 도입**: 거래소 API 부하 70% 감소 (5분 TTL)
- **트랜잭션 분리**: 재할당 결과 DB 저장 지연 방지

*Last Updated: 2025-10-21*
